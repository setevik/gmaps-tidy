# Known Unknowns

Areas requiring further research or validation before `gmaps-tidy` can be considered fully production-ready. Each section now includes **research findings** where available alongside remaining open questions.

---

## 1. DOM Selector Stability

**Risk: Critical**

The entire extension depends on Google's DOM structure remaining stable. Google uses obfuscated CSS class names generated by Closure Compiler/Closure Stylesheets (e.g., `.m6QErb`, `.DxyBCb`) that change frequently with deployments. The extension correctly avoids these in favor of `aria-label`, `data-*`, `role`, and semantic HTML selectors.

### Research Findings

**Automated verification approaches (ranked by priority):**

1. **Multi-strategy fallback selectors** (low effort, high impact): Instead of a single selector per element, define a ranked chain of fallbacks. When the primary selector fails, try alternatives automatically. Log when a fallback is used so breakage is visible.

   ```ts
   // Example: instead of one selector for category
   primary: 'button[jsaction*="pane.rating.category"]'
   fallbacks: ['a[jsaction*="pane.rating.category"]', 'button[aria-label*="Category"]']
   ```

2. **In-extension runtime validation** (low effort, medium impact): After scraping, check that each selector matched at least the expected minimum number of elements. Surface failures as a warning banner in the popup ("Some page selectors may be broken -- extension update may be needed").

3. **Remote selector config** (medium effort, high impact): Host a `selectors.json` on GitHub Pages or a CDN. The extension fetches this on startup and periodically (via `browser.alarms`). Allows pushing selector fixes in minutes without an AMO review cycle. MV3 allows fetching remote *data* (JSON) -- this is not remote code execution. Requires adding the hosting domain to `host_permissions`.

4. **Playwright CI health checks** (medium effort, high impact): Daily GitHub Actions cron job runs Playwright against known-public place pages (`/maps/place/*`), asserts selectors match expected minimums. Auto-opens a GitHub issue on failure. Auth-required pages (`/interests/saved`) would need test-account cookies loaded into the Playwright browser context.

5. **DOM snapshot comparison** (high effort, medium impact): Capture DOM structure diffs when selectors break to help diagnose *what* changed. Useful for debugging, not primary detection.

**Self-healing frameworks (Healenium, Testim.io Smart Locators)** are designed for Selenium test suites with server-side backends -- too heavy for a browser extension with ~20 selectors. The fallback-chain approach above gives 80% of the benefit at 5% of the complexity.

**No public API exists for saved places lists.** Google Takeout exports CSVs (no coordinates for custom lists) and GeoJSON (starred places only). No `batchexecute` RPC IDs for the interests/saved feature have been publicly documented. The DOM-scraping approach is currently the only option for list enumeration and move operations.

### Remaining Open Questions

- **Selector update cadence**: How frequently does Google change the relevant DOM? Unpredictable, but the interests/saved pages (Wiz framework) appear less volatile than the main Maps SPA.
- **Move-operation DOM flow**: Not yet validated end-to-end against a live Google account.

---

## 2. Google Rate Limiting & Bot Detection

**Risk: High**

### Research Findings

- The audit loop opens a tab per place. Randomizing the delay (e.g., 2-5s jitter instead of fixed 2s) reduces bot-detection signal.
- **Hybrid approach** (most impactful mitigation): Scrape only the list page (one page load) to get place names/URLs, then use the [Google Places API](https://developers.google.com/maps/documentation/places/web-service) for status and category data. Eliminates the tab-per-place loop entirely. Cost: ~$17 per 1000 places (Place Details requests). Requires an API key.
- Cookie consent dialogs need detection and dismissal logic. Common selectors: `button[aria-label*="Accept"]`, `button[id*="consent"]`.

### Remaining Open Questions

- **Throttling thresholds**: Exact request rate triggering CAPTCHAs or session invalidation unknown.
- **Detection signals**: Whether `tabs.create({ active: false })` is flagged differently from user navigation is unknown.
- **Session/cookie behavior**: Whether rapid tab creation causes session invalidation needs live testing.

---

## 3. Large List Performance & Pagination

**Risk: Medium-High**

### Research Findings

**500-item server-side limit:**
- Google Maps has an official limit of **500 entries per saved list** (introduced ~June 2023). Lists beyond this may not display properly or may lose older entries.
- Some users report lists with 1600+ places, suggesting enforcement varies.
- The extension should warn users if a list is at/near this limit.

**Pagination mechanics:**
- List detail pages use **traditional lazy-append infinite scroll** (not virtual scroll). Items are appended to the DOM as the user scrolls; previously loaded items remain. This is why `scrollToLoadAll()` works correctly.
- Batch size appears to be ~20 items per scroll.
- The scroll container is `div[data-viewer-group][data-id]` (`listDataContainer` selector).
- `maxScrolls = 50` at ~20 items/batch = ~1000 items max. Sufficient given the 500-item limit, but the 500ms inter-scroll delay may be too short for slow networks. Consider adaptive waiting.

**Top-level saved page pagination:**
- If a user has many collections (20+), a **"More" button** appears at the bottom. The current `scrapeListCards()` does a single synchronous `querySelectorAll` pass and will **miss collections behind this button**. Needs scrolling or "More" button clicking.

**The "99+ items" display cap:**
- The aria-label shows "99+ items" for large lists. `parseInt("99+ items", 10)` returns `99`. The stored `placeCount` will be an undercount. Consider flagging this as approximate.

### Remaining Open Questions

- **IndexedDB capacity**: Practical storage limits for thousands of Place objects. Quota-exceeded handling is missing.
- **Memory pressure**: Whether opening/closing hundreds of tabs leaks memory in Firefox.
- **Alarm reliability**: Whether the alarm-driven audit loop works reliably over 17+ minute durations.

---

## 4. Move Operation Reliability & Item Order

**Risk: High**

### Research Findings

**Item ordering:**
- Default order on the web is **reverse chronological** (most recently added first).
- **No sort/reorder UI exists on the desktop web.** Manual reorder is Android-only (drag-and-drop in edit mode). Custom order set on Android may not propagate to the desktop web view.
- DOM order matches display order. No CSS `flex-order` or grid reordering is used.
- The extension can treat web list order as stable between scrapes.

**Stable identifiers:**
- `data-item-id` on each `div[data-item-id]` is a per-item stable identifier (likely a Feature ID / hex).
- `mapsUrl` (containing Place ID) is the best long-term key -- already used as IndexedDB `keyPath`. Place IDs may become invalid after ~12 months (~15% turnover per year).
- Place names can change (business renames) -- not reliable as sole identifier.

**Move safety / DOM shifting:**
- The current implementation finds each item by **name-based selector** (`button[aria-label="More options for ${placeName}"]`), NOT by positional index. This is inherently resilient to DOM shifting when items are removed.
- After a move, the item is removed from the DOM. The 1000ms delay gives time for this.
- Edge case: duplicate place names could cause the wrong item to be selected.
- Consider processing moves in **reverse DOM order** (bottom to top) for extra safety, and adding a post-move DOM check to confirm the item actually disappeared.

### Remaining Open Questions

- **Move confirmation flow**: Whether Google shows a confirmation dialog after selecting the target list.
- **Target list creation**: Whether the picker shows a "create new list" option if the target doesn't exist.
- **Batch vs sequential**: Whether Google's UI supports multi-select moves.
- **Undo/rollback**: No automated undo mechanism exists.

---

## 5. List View vs. Gallery Mode

**Risk: Medium**

### Research Findings

- Google Saved/Collections supports two view modes per collection: **Grid view** (masonry with large thumbnails) and **List view** (compact text rows).
- The mode is a **per-collection server-side setting**, chosen at creation or via the "Edit" flow. There is **no URL parameter** to force list vs. grid.
- The toggle is accessed through the collection's "More options" menu → "Edit" flow -- not a simple on-page toggle button.
- For **Maps place lists specifically**, the list detail pages at `/interests/saved/list/...` appear to consistently use a list-like layout regardless of the collection's view mode setting. The grid/list toggle is more relevant to general Google Collections (saved links, images).
- In grid mode, less text content is rendered per item, and the DOM structure may differ. The current selectors (`div[data-item-id]`, `a[href*="/maps/place/"]`) are designed for list view.

### Action Items

- After navigating to a list detail page, detect whether the page is in list or grid mode by checking whether expected list-view selectors resolve.
- If grid mode is detected, either switch to list mode programmatically (via edit flow) or warn the user.
- Empirical testing needed to confirm whether Maps place lists can ever appear in grid mode.

---

## 6. Authentication & Session State

**Risk: Medium**

### Research Findings

**The browser-session approach is correct.** No existing tool scrapes saved places from within an authenticated session -- every other tool in the ecosystem relies on Google Takeout files. The content-script-in-authenticated-session pattern is unique and, for this use case, the right architecture.

**Alternative approaches evaluated:**

| Approach | Verdict | Why |
|----------|---------|-----|
| Existing browser session (current) | **Keep** | Simplest. User is already logged in. No extra setup. |
| Sandboxed browser (Puppeteer/Playwright) | Not practical | Cannot be launched from a Firefox extension. Would require a separate app. |
| Native messaging + companion Node.js app | Overkill | Extreme setup complexity for end users. |
| Connect to existing browser via CDP | Not compatible | CDP is Chromium-only. Firefox uses different protocol. |
| Google Takeout | Insufficient | Exports CSVs without coordinates for custom lists. Export-only -- cannot move places. |
| OAuth + Google APIs | No API exists | No Google API exposes saved places / interest lists. |
| Google Places API (hybrid) | Valuable complement | Can replace per-place tab scraping for status/category data (~$17/1000 places). |

**Multi-account handling:**
- `google.com/interests/saved` uses the default account. For non-default accounts, the URL needs an `authuser=N` parameter (e.g., `?authuser=1`). The extension should support this.

**Session validity detection:**
- Content scripts should detect login redirects (URL changing to `accounts.google.com`) and report back rather than silently failing.

### Remaining Open Questions

- **Session expiry mid-audit**: Whether a 30-minute audit can survive without re-authentication.
- **Incognito mode**: Whether the extension works in private browsing (likely not, since cookies won't be available).

---

## 7. Firefox MV3 Event Page Behavior

**Risk: Medium**

### Remaining Open Questions (unchanged)

- **Suspension timing**: How quickly Firefox suspends an idle event page. Whether 2-second delays trigger suspension.
- **Alarm granularity**: Whether `delayInMinutes: 0.033` (2 seconds) actually fires at 2 seconds on current Firefox. Minimum alarm delay may be 1 minute.
- **Tab API from suspended context**: Whether `browser.tabs.create()` works immediately after alarm wakeup.
- **Concurrent message handling**: Whether popup messages during alarm handlers cause state corruption.

---

## 8. Place Status Detection Accuracy

**Risk: Medium**

### Remaining Open Questions (unchanged)

- **False positives**: Review text mentioning "permanently closed" could trigger false detection. `document.body.innerText` includes reviews and user content.
- **Localization**: Only works for English-language Google Maps. No i18n support.
- **Other statuses**: "Moved to a new location", "Under renovation", seasonal closures not handled.
- **Not-found heuristic**: Missing `<h1>` may false-positive on slow-loading pages.

---

## 9. Category Matching Quality

**Risk: Medium**

### Remaining Open Questions (unchanged)

- **Multi-category places**: First-match-wins may not match user intent for "Restaurant · Bar".
- **Category taxonomy**: No official full list of Google Maps categories.
- **Category consistency**: May vary by locale, language, or device.
- **Unmapped categories**: Report should highlight unmapped categories to help users refine mappings.

---

## 10. Distribution & Update Strategy

**Risk: Low (but necessary for real users)**

### Remaining Open Questions (unchanged)

- **AMO submission**: Whether DOM-scraping + `host_permissions` for `google.com` passes Mozilla review.
- **Update mechanism**: Remote selector config (section 1) would bypass slow AMO review cycles.
- **Privacy policy**: May be required even though no data leaves the browser.
- **Minimum Firefox version**: Needs verification for MV3 API support.

---

## 11. Error Recovery & User Communication

**Risk: Medium**

### Remaining Open Questions (unchanged)

- **Retry strategies**: Scraping is safe to retry; moves are dangerous to retry (may have already executed).
- **Error messaging**: User-facing messages need to be actionable, not raw selector strings.
- **Partial audit recovery**: IndexedDB consistency between writing a place result and advancing the queue index.

---

## Summary Priority Matrix

| # | Area | Risk | Research Status | Impact of Not Resolving |
|---|------|------|----------------|------------------------|
| 1 | DOM Selector Stability | Critical | **Approaches identified** | Extension stops working entirely |
| 2 | Rate Limiting / Bot Detection | High | Partially researched | Account lockout or CAPTCHAs mid-audit |
| 4 | Move Operation Reliability | High | **Order/shifting researched** | User data corruption (wrong list moves) |
| 3 | Large List Performance | Medium-High | **Pagination researched** | Audit hangs or misses items |
| 5 | List View vs Gallery Mode | Medium | **Researched** | Selectors fail in grid mode |
| 6 | Auth & Session State | Medium | **Approaches evaluated** | Silent failures for multi-account users |
| 7 | Event Page Behavior | Medium | Open | Audit stalls or loses progress silently |
| 8 | Place Status Detection | Medium | Open | False positives/negatives in audit |
| 9 | Category Matching | Medium | Open | Places sorted into wrong lists |
| 11 | Error Recovery | Medium | Open | Users stuck with no clear fix |
| 10 | Distribution | Low | Open | Blocks public release |

## Recommended Implementation Order

Based on research, the highest-leverage changes for full functionality:

| Priority | Change | Effort | Impact |
|----------|--------|--------|--------|
| 1 | Add fallback selector chains to `selectors.ts` | Low | Immediate resilience to minor DOM changes |
| 2 | Add runtime selector validation + user warning | Low | Users know when something breaks |
| 3 | Fix top-level page pagination (handle "More" button) | Low | All collections are discovered |
| 4 | Add `authuser` parameter support for multi-account | Low | Correct account's data is scraped |
| 5 | Add session-validity detection (login redirect check) | Low | Graceful failure instead of silent corruption |
| 6 | Add adaptive scroll timing in `scrollToLoadAll()` | Low | Large lists load completely |
| 7 | Remote selector config (GitHub Pages JSON) | Medium | Selector fixes deploy in minutes |
| 8 | Playwright CI selector health checks | Medium | Proactive breakage detection |
| 9 | List/grid mode detection and enforcement | Medium | Correct scraping regardless of mode |
| 10 | Places API hybrid for status/category data | Medium | Eliminates tab-per-place bot risk |
